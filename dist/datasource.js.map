{"version":3,"sources":["../src/datasource.js"],"names":[],"mappings":"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","file":"datasource.js","sourcesContent":["// Copyright 2016 Fraunhofer Institute for Applied Information Technology FIT\n\nimport _ from \"lodash\";\n\nexport class GenericDatasource {\n\n  constructor(instanceSettings, $q, backendSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n  }\n\n  // Required\n  // Used for testing datasource in datasource configuration page\n  testDatasource() {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/',\n      method: 'GET'\n    }).then(response => {\n      if (response.status === 200) {\n        return {status: \"success\", message: \"Data source is working\", title: \"Success\"};\n      }\n    });\n  }\n\n  // Query data from Data API\n  // Called once per panel (graph)\n  query(options) {\n    var query = this.filterPlaceholders(options);\n    //console.log(\"query QUERY:\", JSON.stringify(query));\n\n    // Filter targets that are set to hidden\n    query.targets = _.filter(query.targets, target => {\n      return target.hide != true;\n    });\n\n    // All targets filtered OR no metric selected\n    if (query.targets.length == 0 || !('metric' in query.targets[0])) {\n      return {data: []}; // return this.q.when([]);\n    }\n\n    // Make a new array with zero-valued object fields\n    var entries = Array.apply(null, Array(query.targets.length)).map(function () {\n      return {target: '', datapoints: []};\n    });\n\n    var parent = this;\n    // Recursively query all pages of every target\n    function recursiveReq(page, idi) {\n      var target = query.targets[idi];\n      var source = target.source;\n      var apiEndpoint = \"data/\";\n      var senmlFields = {value: \"v\", time: \"t\"};\n      // Query for aggregation data\n      if (!source.startsWith(\"value\")) {\n        apiEndpoint = \"aggr/\" + target.Aggrs[source].id + \"/\";\n        senmlFields.value = target.Aggrs[source].aggregate;\n        senmlFields.time = \"ts\";\n      }\n\n      var uuid = target.UUIDs[target.metric];\n      return parent.backendSrv.datasourceRequest({\n        url: parent.url + \"/\" + apiEndpoint + uuid +\n        '?start=' + query.range.from.toISOString() + '&end=' + query.range.to.toISOString() + '&page=' + page,\n        data: query,\n        method: 'GET'\n      }).then(function (d) {\n        var total = d.data.total; // total from data api\n        var datapoints = parent.convertData(d.data, senmlFields);\n        // append aggregate name to metric title\n        var aggregate = senmlFields.value == 'v' ? '' : '.' + senmlFields.value;\n        entries[idi].target = target.metric + aggregate;\n        entries[idi].datapoints = entries[idi].datapoints.concat(datapoints);\n\n        if (total > entries[idi].datapoints.length) {\n          // query the next page\n          return recursiveReq(++page, idi);\n        } else if (idi < query.targets.length - 1) {\n          // one target done, query the next target\n          return recursiveReq(1, ++idi);\n        } else {\n          // all done\n          d.data = entries;\n          return d;\n        }\n\n      });\n    } // end func\n\n    // Start from page 1, id 0\n    return recursiveReq(1, 0);\n  }\n\n  // Convert historical SenML data from Data/Aggr API to Grafana datapoints\n  convertData(data, senmlFields) {\n    var datapoints = Array(data.data.e.length);\n    for (var i = 0; i < data.data.e.length; i++) {\n      datapoints[i] = [data.data.e[i][senmlFields.value], data.data.e[i][senmlFields.time] * 1000];\n    }\n\n    return datapoints;\n  }\n\n  // Remove targets that have unselected metric or source\n  filterPlaceholders(options) {\n    options.targets = _.filter(options.targets, target => {\n      return target.metric !== 'select metric' && target.source !== 'select source';\n    });\n\n    return options;\n  }\n\n  // Query list of metrics from Registry API\n  // Required for templating\n  queryMetrics(options) {\n    return this.backendSrv.datasourceRequest({\n      //url: this.url + '/search',\n      url: this.url + '/registry',\n      data: options,\n      method: 'GET',\n      //headers: { 'Content-Type': 'application/json' }\n    }).then(this.convertMetrics);\n  }\n\n  // Convert registration from Registry API to the format required by Grafana\n  convertMetrics(res) {\n    return _.map(res.data.entries, (d, i) => {\n      return {\n        uuid: d.id,\n        legend: '(' + d.id.split('-')[0] + ') ' + d.resource, // (first 4 bytes of uuid) resource name\n        text: d.id + ' : ' + d.resource,\n        value: i\n      };\n    });\n  }\n\n  // Query list of sources of data (value and aggregations) from Registry API\n  // Required for templating\n  querySources(options) {\n    // Metric is not selected\n    if (options.metric == 'select metric') {\n      return new Promise((resolve, reject) => {\n        reject(\"metric not selected\");\n      });\n    }\n\n    var uuid = options.UUIDs[options.metric];\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/registry/' + uuid,\n      method: 'GET',\n      //headers: { 'Content-Type': 'application/json' }\n    }).then(this.convertSources);\n  }\n\n  // Convert meta data about aggregates from Registry API to the format required by Grafana\n  convertSources(res) {\n    function formatRetention(retention) {\n      if (retention == \"\") {\n        return \", retention ∞\"; // infinite retention\n      }\n      return ', retention ' + retention;\n    }\n\n    var index = 0;\n    // raw un-aggregated data\n    var value = {id: 'value', text: 'value' + formatRetention(res.data.retention), value: index++};\n    // Flatten aggregations of a target (datasource)\n    // start with 'value' as input and concatenate flattened aggregates\n    var r = _.reduce(res.data.aggregation, (input, a) => {\n      // Flatten and format aggregates\n      var r2 = _.reduce(a.aggregates, (array, aggregate) => {\n        array.push({\n          id: a.id,\n          aggregate: aggregate,\n          text: aggregate + ', every ' + a.interval + formatRetention(a.retention),\n          value: index++\n        });\n        return array;\n      }, []);\n\n      return input.concat(r2);\n    }, [value]);\n\n    // sort aggregates\n    r = [r[0]].concat(_.sortBy(r.slice(1, r.length), 'text'));\n    return r;\n\n  }\n}\n"]}